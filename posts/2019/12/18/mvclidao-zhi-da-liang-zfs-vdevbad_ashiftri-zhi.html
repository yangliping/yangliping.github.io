<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>mvcli导致大量zfs vdev.bad_ashift日志 &mdash; Liping's Blog</title>
  <meta name="author" content="Yang Liping">






  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">


    <link href="http://www.yanglp.com/favicon.png" rel="icon">

  <link href="http://www.yanglp.com/theme/css/main.css" media="screen, projection"
        rel="stylesheet" type="text/css">

  <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
</head>

<body>
  <header role="banner"><hgroup>
  <h1><a href="http://www.yanglp.com/">Liping's Blog</a></h1>
    <h2>翁曰：「無他，但手熟爾。」</h2>
</hgroup></header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
</ul>

<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="www.yanglp.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>

<ul class="main-navigation">
    <li><a href="/">Home</a></li>
    <li><a href="/archives">Arcives</a></li>
</ul></nav>
  <div id="main">
    <div id="content">
<div>
  <article class="hentry" role="article">
<header>
      <h1 class="entry-title">mvcli导致大量zfs vdev.bad_ashift日志</h1>
    <p class="meta">
<time datetime="2019-12-18T10:59:44.702032+08:00" pubdate>Wed 18 December 2019</time>    </p>
</header>

  <div class="entry-content"><h3>发现问题</h3>
<p>上周从每天的日志统计日报发现，突然部分存储服务器开始大量出现类似以下的日志：</p>
<div class="highlight"><pre><span class="n">Dec</span> <span class="mi">10</span> <span class="mi">15</span><span class="o">:</span><span class="mi">13</span><span class="o">:</span><span class="mi">59</span> <span class="n">myserver</span> <span class="n">kernel</span><span class="o">:</span> <span class="p">[</span><span class="mf">17475246.696258</span><span class="p">]</span>  <span class="n">sdal</span><span class="o">:</span> <span class="n">sdal1</span> <span class="n">sdal9</span>
<span class="n">Dec</span> <span class="mi">10</span> <span class="mi">15</span><span class="o">:</span><span class="mi">13</span><span class="o">:</span><span class="mi">59</span> <span class="n">myserver</span> <span class="n">kernel</span><span class="o">:</span> <span class="n">sdal</span><span class="o">:</span> <span class="n">sdal1</span> <span class="n">sdal9</span>
<span class="n">Dec</span> <span class="mi">10</span> <span class="mi">15</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="mo">00</span> <span class="n">myserver</span> <span class="n">kernel</span><span class="o">:</span> <span class="p">[</span><span class="mf">17475246.882323</span><span class="p">]</span>  <span class="n">sdam</span><span class="o">:</span> <span class="n">sdam1</span> <span class="n">sdam9</span>
<span class="n">Dec</span> <span class="mi">10</span> <span class="mi">15</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="mo">00</span> <span class="n">myserver</span> <span class="n">kernel</span><span class="o">:</span> <span class="n">sdam</span><span class="o">:</span> <span class="n">sdam1</span> <span class="n">sdam9</span>
<span class="n">Dec</span> <span class="mi">10</span> <span class="mi">15</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="mo">00</span> <span class="n">myserver</span> <span class="n">kernel</span><span class="o">:</span> <span class="p">[</span><span class="mf">17475246.948613</span><span class="p">]</span>  <span class="n">sdan</span><span class="o">:</span> <span class="n">sdan1</span> <span class="n">sdan9</span>
<span class="n">Dec</span> <span class="mi">10</span> <span class="mi">15</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="mo">00</span> <span class="n">myserver</span> <span class="n">kernel</span><span class="o">:</span> <span class="n">sdan</span><span class="o">:</span> <span class="n">sdan1</span> <span class="n">sdan9</span>
<span class="n">Dec</span> <span class="mi">10</span> <span class="mi">15</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="mo">00</span> <span class="n">myserver</span> <span class="n">kernel</span><span class="o">:</span> <span class="p">[</span><span class="mf">17475247.044814</span><span class="p">]</span>  <span class="n">sdao</span><span class="o">:</span> <span class="n">sdao1</span> <span class="n">sdao9</span>
<span class="n">Dec</span> <span class="mi">10</span> <span class="mi">15</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="mo">00</span> <span class="n">myserver</span> <span class="n">kernel</span><span class="o">:</span> <span class="n">sdao</span><span class="o">:</span> <span class="n">sdao1</span> <span class="n">sdao9</span>
<span class="n">Dec</span> <span class="mi">10</span> <span class="mi">15</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="mo">00</span> <span class="n">myserver</span> <span class="n">kernel</span><span class="o">:</span> <span class="p">[</span><span class="mf">17475247.157436</span><span class="p">]</span>  <span class="n">sdap</span><span class="o">:</span> <span class="n">sdap1</span> <span class="n">sdap9</span>
<span class="n">Dec</span> <span class="mi">10</span> <span class="mi">15</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="mo">00</span> <span class="n">myserver</span> <span class="n">kernel</span><span class="o">:</span> <span class="n">sdap</span><span class="o">:</span> <span class="n">sdap1</span> <span class="n">sdap9</span>
<span class="n">Dec</span> <span class="mi">10</span> <span class="mi">15</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="mo">00</span> <span class="n">myserver</span> <span class="n">kernel</span><span class="o">:</span> <span class="p">[</span><span class="mf">17475247.223108</span><span class="p">]</span>  <span class="n">sdbe</span><span class="o">:</span> <span class="n">sdbe1</span> <span class="n">sdbe9</span>
<span class="n">Dec</span> <span class="mi">10</span> <span class="mi">15</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="mo">00</span> <span class="n">myserver</span> <span class="n">kernel</span><span class="o">:</span> <span class="n">sdbe</span><span class="o">:</span> <span class="n">sdbe1</span> <span class="n">sdbe9</span>
<span class="n">Dec</span> <span class="mi">10</span> <span class="mi">15</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="mo">00</span> <span class="n">myserver</span> <span class="n">zed</span><span class="o">:</span> <span class="n">eid</span><span class="o">=</span><span class="mi">14661</span> <span class="n">class</span><span class="o">=</span><span class="n">vdev</span><span class="p">.</span><span class="n">bad_ashift</span> <span class="n">pool_guid</span><span class="o">=</span><span class="mh">0x84383CC58AC07C5C</span> <span class="n">vdev_path</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">disk</span><span class="o">/</span><span class="n">by</span><span class="o">-</span><span class="n">id</span><span class="o">/</span><span class="n">scsi</span><span class="o">-</span><span class="mi">35000</span><span class="n">cca273704d68</span><span class="o">-</span><span class="n">part1</span>
<span class="n">Dec</span> <span class="mi">10</span> <span class="mi">15</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="mo">00</span> <span class="n">myserver</span> <span class="n">zed</span><span class="o">:</span> <span class="n">eid</span><span class="o">=</span><span class="mi">14662</span> <span class="n">class</span><span class="o">=</span><span class="n">vdev</span><span class="p">.</span><span class="n">bad_ashift</span> <span class="n">pool_guid</span><span class="o">=</span><span class="mh">0x84383CC58AC07C5C</span> <span class="n">vdev_path</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">disk</span><span class="o">/</span><span class="n">by</span><span class="o">-</span><span class="n">id</span><span class="o">/</span><span class="n">scsi</span><span class="o">-</span><span class="mi">35000</span><span class="n">cca2736fab64</span><span class="o">-</span><span class="n">part1</span>
<span class="n">Dec</span> <span class="mi">10</span> <span class="mi">15</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="mo">00</span> <span class="n">myserver</span> <span class="n">zed</span><span class="o">:</span> <span class="n">eid</span><span class="o">=</span><span class="mi">14663</span> <span class="n">class</span><span class="o">=</span><span class="n">vdev</span><span class="p">.</span><span class="n">bad_ashift</span> <span class="n">pool_guid</span><span class="o">=</span><span class="mh">0x84383CC58AC07C5C</span> <span class="n">vdev_path</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">disk</span><span class="o">/</span><span class="n">by</span><span class="o">-</span><span class="n">id</span><span class="o">/</span><span class="n">scsi</span><span class="o">-</span><span class="mi">35000</span><span class="n">cca2737014b0</span><span class="o">-</span><span class="n">part1</span>
<span class="n">Dec</span> <span class="mi">10</span> <span class="mi">15</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="mo">00</span> <span class="n">myserver</span> <span class="n">kernel</span><span class="o">:</span> <span class="p">[</span><span class="mf">17475247.316825</span><span class="p">]</span>  <span class="n">sdbf</span><span class="o">:</span> <span class="n">sdbf1</span> <span class="n">sdbf9</span>
<span class="n">Dec</span> <span class="mi">10</span> <span class="mi">15</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="mo">00</span> <span class="n">myserver</span> <span class="n">kernel</span><span class="o">:</span> <span class="n">sdbf</span><span class="o">:</span> <span class="n">sdbf1</span> <span class="n">sdbf9</span>
<span class="n">Dec</span> <span class="mi">10</span> <span class="mi">15</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="mo">00</span> <span class="n">myserver</span> <span class="n">zed</span><span class="o">:</span> <span class="n">eid</span><span class="o">=</span><span class="mi">14664</span> <span class="n">class</span><span class="o">=</span><span class="n">vdev</span><span class="p">.</span><span class="n">bad_ashift</span> <span class="n">pool_guid</span><span class="o">=</span><span class="mh">0x84383CC58AC07C5C</span> <span class="n">vdev_path</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">sdab1</span>
<span class="n">Dec</span> <span class="mi">10</span> <span class="mi">15</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="mo">00</span> <span class="n">myserver</span> <span class="n">zed</span><span class="o">:</span> <span class="n">eid</span><span class="o">=</span><span class="mi">14665</span> <span class="n">class</span><span class="o">=</span><span class="n">vdev</span><span class="p">.</span><span class="n">bad_ashift</span> <span class="n">pool_guid</span><span class="o">=</span><span class="mh">0x84383CC58AC07C5C</span> <span class="n">vdev_path</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">disk</span><span class="o">/</span><span class="n">by</span><span class="o">-</span><span class="n">id</span><span class="o">/</span><span class="n">scsi</span><span class="o">-</span><span class="mi">35000</span><span class="n">cca2736efbe0</span><span class="o">-</span><span class="n">part1</span>
<span class="n">Dec</span> <span class="mi">10</span> <span class="mi">15</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="mo">00</span> <span class="n">myserver</span> <span class="n">zed</span><span class="o">:</span> <span class="n">eid</span><span class="o">=</span><span class="mi">14666</span> <span class="n">class</span><span class="o">=</span><span class="n">vdev</span><span class="p">.</span><span class="n">bad_ashift</span> <span class="n">pool_guid</span><span class="o">=</span><span class="mh">0x84383CC58AC07C5C</span> <span class="n">vdev_path</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">disk</span><span class="o">/</span><span class="n">by</span><span class="o">-</span><span class="n">id</span><span class="o">/</span><span class="n">scsi</span><span class="o">-</span><span class="mi">35000</span><span class="n">cca273704c34</span><span class="o">-</span><span class="n">part1</span>
<span class="n">Dec</span> <span class="mi">10</span> <span class="mi">15</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="mo">00</span> <span class="n">myserver</span> <span class="n">zed</span><span class="o">:</span> <span class="n">eid</span><span class="o">=</span><span class="mi">14667</span> <span class="n">class</span><span class="o">=</span><span class="n">vdev</span><span class="p">.</span><span class="n">bad_ashift</span> <span class="n">pool_guid</span><span class="o">=</span><span class="mh">0x84383CC58AC07C5C</span> <span class="n">vdev_path</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">disk</span><span class="o">/</span><span class="n">by</span><span class="o">-</span><span class="n">id</span><span class="o">/</span><span class="n">scsi</span><span class="o">-</span><span class="mi">35000</span><span class="n">cca2737051c8</span><span class="o">-</span><span class="n">part1</span>
<span class="n">Dec</span> <span class="mi">10</span> <span class="mi">15</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="mo">00</span> <span class="n">myserver</span> <span class="n">zed</span><span class="o">:</span> <span class="n">eid</span><span class="o">=</span><span class="mi">14668</span> <span class="n">class</span><span class="o">=</span><span class="n">vdev</span><span class="p">.</span><span class="n">bad_ashift</span> <span class="n">pool_guid</span><span class="o">=</span><span class="mh">0x84383CC58AC07C5C</span> <span class="n">vdev_path</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">disk</span><span class="o">/</span><span class="n">by</span><span class="o">-</span><span class="n">id</span><span class="o">/</span><span class="n">scsi</span><span class="o">-</span><span class="mi">35000</span><span class="n">cca273704fac</span><span class="o">-</span><span class="n">part1</span>
<span class="n">Dec</span> <span class="mi">10</span> <span class="mi">15</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="mo">00</span> <span class="n">myserver</span> <span class="n">zed</span><span class="o">:</span> <span class="n">eid</span><span class="o">=</span><span class="mi">14669</span> <span class="n">class</span><span class="o">=</span><span class="n">vdev</span><span class="p">.</span><span class="n">bad_ashift</span> <span class="n">pool_guid</span><span class="o">=</span><span class="mh">0x84383CC58AC07C5C</span> <span class="n">vdev_path</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">disk</span><span class="o">/</span><span class="n">by</span><span class="o">-</span><span class="n">id</span><span class="o">/</span><span class="n">scsi</span><span class="o">-</span><span class="mi">35000</span><span class="n">cca27370a2bc</span><span class="o">-</span><span class="n">part1</span>
</pre></div>


<p>zpool events日志如下：</p>
<div class="highlight"><pre><span class="cp"># zpool events -v</span>
<span class="n">TIME</span>                           <span class="n">CLASS</span>
<span class="n">Dec</span> <span class="mi">13</span> <span class="mi">2019</span> <span class="mi">09</span><span class="o">:</span><span class="mi">57</span><span class="o">:</span><span class="mf">53.616088963</span> <span class="n">ereport</span><span class="p">.</span><span class="n">fs</span><span class="p">.</span><span class="n">zfs</span><span class="p">.</span><span class="n">vdev</span><span class="p">.</span><span class="n">bad_ashift</span>
        <span class="n">class</span> <span class="o">=</span> <span class="s">&quot;ereport.fs.zfs.vdev.bad_ashift&quot;</span>
        <span class="n">ena</span> <span class="o">=</span> <span class="mh">0xfeed7bfb2ca01401</span>
        <span class="n">detector</span> <span class="o">=</span> <span class="p">(</span><span class="n">embedded</span> <span class="n">nvlist</span><span class="p">)</span>
                <span class="n">version</span> <span class="o">=</span> <span class="mh">0x0</span>
                <span class="n">scheme</span> <span class="o">=</span> <span class="s">&quot;zfs&quot;</span>
                <span class="n">pool</span> <span class="o">=</span> <span class="mh">0x176af123486292aa</span>
                <span class="n">vdev</span> <span class="o">=</span> <span class="mh">0x7a3902d1006a3b0f</span>
        <span class="p">(</span><span class="n">end</span> <span class="n">detector</span><span class="p">)</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="s">&quot;ost_98&quot;</span>
        <span class="n">pool_guid</span> <span class="o">=</span> <span class="mh">0x176af123486292aa</span>
        <span class="n">pool_state</span> <span class="o">=</span> <span class="mh">0x0</span>
        <span class="n">pool_context</span> <span class="o">=</span> <span class="mh">0x0</span>
        <span class="n">pool_failmode</span> <span class="o">=</span> <span class="s">&quot;wait&quot;</span>
        <span class="n">vdev_guid</span> <span class="o">=</span> <span class="mh">0x7a3902d1006a3b0f</span>
        <span class="n">vdev_type</span> <span class="o">=</span> <span class="s">&quot;disk&quot;</span>
        <span class="n">vdev_path</span> <span class="o">=</span> <span class="s">&quot;/dev/disk/by-id/scsi-35000cca27366b0e8-part1&quot;</span>
        <span class="n">vdev_devid</span> <span class="o">=</span> <span class="s">&quot;scsi-35000cca27366b0e8-part1&quot;</span>
        <span class="n">vdev_enc_sysfs_path</span> <span class="o">=</span> <span class="s">&quot;/sys/class/enclosure/0:0:0:0/7&quot;</span>
        <span class="n">vdev_ashift</span> <span class="o">=</span> <span class="mh">0xc</span>
        <span class="n">vdev_complete_ts</span> <span class="o">=</span> <span class="mh">0x56feed6a4da4d</span>
        <span class="n">vdev_delta_ts</span> <span class="o">=</span> <span class="mh">0xce0f5</span>
        <span class="n">vdev_read_errors</span> <span class="o">=</span> <span class="mh">0x0</span>
        <span class="n">vdev_write_errors</span> <span class="o">=</span> <span class="mh">0x0</span>
        <span class="n">vdev_cksum_errors</span> <span class="o">=</span> <span class="mh">0x0</span>
        <span class="n">parent_guid</span> <span class="o">=</span> <span class="mh">0x945a8813ce9c944d</span>
        <span class="n">parent_type</span> <span class="o">=</span> <span class="s">&quot;raidz&quot;</span>
        <span class="n">vdev_spare_paths</span> <span class="o">=</span>
        <span class="n">vdev_spare_guids</span> <span class="o">=</span>
        <span class="n">prev_state</span> <span class="o">=</span> <span class="mh">0x0</span>
        <span class="n">time</span> <span class="o">=</span> <span class="mh">0x5df2f021</span> <span class="mh">0x24b8c583</span>
        <span class="n">eid</span> <span class="o">=</span> <span class="mh">0x183aa1</span>

<span class="cp"># zpool events</span>
 <span class="n">TIME</span>                           <span class="n">CLASS</span>
<span class="n">Dec</span> <span class="mi">13</span> <span class="mi">2019</span> <span class="mi">09</span><span class="o">:</span><span class="mi">57</span><span class="o">:</span><span class="mf">53.616088963</span> <span class="n">ereport</span><span class="p">.</span><span class="n">fs</span><span class="p">.</span><span class="n">zfs</span><span class="p">.</span><span class="n">vdev</span><span class="p">.</span><span class="n">bad_ashift</span>
<span class="n">Dec</span> <span class="mi">13</span> <span class="mi">2019</span> <span class="mi">09</span><span class="o">:</span><span class="mi">57</span><span class="o">:</span><span class="mf">53.616088963</span> <span class="n">ereport</span><span class="p">.</span><span class="n">fs</span><span class="p">.</span><span class="n">zfs</span><span class="p">.</span><span class="n">vdev</span><span class="p">.</span><span class="n">bad_ashift</span>
<span class="n">Dec</span> <span class="mi">13</span> <span class="mi">2019</span> <span class="mi">09</span><span class="o">:</span><span class="mi">57</span><span class="o">:</span><span class="mf">53.616088963</span> <span class="n">ereport</span><span class="p">.</span><span class="n">fs</span><span class="p">.</span><span class="n">zfs</span><span class="p">.</span><span class="n">vdev</span><span class="p">.</span><span class="n">bad_ashift</span>
<span class="n">Dec</span> <span class="mi">13</span> <span class="mi">2019</span> <span class="mi">09</span><span class="o">:</span><span class="mi">57</span><span class="o">:</span><span class="mf">53.616088963</span> <span class="n">ereport</span><span class="p">.</span><span class="n">fs</span><span class="p">.</span><span class="n">zfs</span><span class="p">.</span><span class="n">vdev</span><span class="p">.</span><span class="n">bad_ashift</span>
<span class="n">Dec</span> <span class="mi">13</span> <span class="mi">2019</span> <span class="mi">09</span><span class="o">:</span><span class="mi">57</span><span class="o">:</span><span class="mf">53.616088963</span> <span class="n">ereport</span><span class="p">.</span><span class="n">fs</span><span class="p">.</span><span class="n">zfs</span><span class="p">.</span><span class="n">vdev</span><span class="p">.</span><span class="n">bad_ashift</span>
<span class="n">Dec</span> <span class="mi">13</span> <span class="mi">2019</span> <span class="mi">09</span><span class="o">:</span><span class="mi">57</span><span class="o">:</span><span class="mf">53.616088963</span> <span class="n">ereport</span><span class="p">.</span><span class="n">fs</span><span class="p">.</span><span class="n">zfs</span><span class="p">.</span><span class="n">vdev</span><span class="p">.</span><span class="n">bad_ashift</span>
</pre></div>


<p>单单从日志来看，其实并不容易发现是什么问题。但对比不同的服务器日志后，很快就能发现大量日志的出现是从<code>Dec 10 15:00:00</code>时间左右开始发生的，因此判断当时应该做了一些变更。从审计日志中查看当时执行的记录，发现是修改了raid状态检查的脚本。执行脚本马上就会出现类似的日志，证明脚本的执行是起因。进一步分析脚本，确定是<code>mvlci</code>这个Marvell公司的raid卡状态检测工具造成的。</p>
<h3>zfs-zed</h3>
<p><code>vdev.bad_ashift</code>错误是在<code>vdev_open()</code>的时候产生的，可能会造成性能问题，但对数据安全性应该不会有太大影响，参考：<a href="https://utcc.utoronto.ca/~cks/space/blog/solaris/ZFS4KDiskWithAshift9">What happens in ZFS when you have 4K sector disks in an ashift=9 vdev</a>。代码注释中也说只是抛出event而不直接error让pool不可用，可见并不算严重错误。</p>
<div class="highlight"><pre><span class="cm">/* zfs-0.7.9 - include/sys/fm/fs/zfs.h */</span>
<span class="cp">#define FM_EREPORT_ZFS_DEVICE_BAD_ASHIFT    &quot;vdev.bad_ashift&quot;</span>


<span class="cm">/* zfs-0.7.9 - module/zfs/vdev.c */</span>

<span class="cm">/*</span>
<span class="cm"> * Prepare a virtual device for access.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">vdev_open</span><span class="p">(</span><span class="kt">vdev_t</span> <span class="o">*</span><span class="n">vd</span><span class="p">)</span>
<span class="p">{</span>
  <span class="cm">/* ... skipped ... */</span>

        <span class="cm">/*</span>
<span class="cm">         * Detect if the alignment requirement has increased.</span>
<span class="cm">         * We don&#39;t want to make the pool unavailable, just</span>
<span class="cm">         * post an event instead.</span>
<span class="cm">         */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ashift</span> <span class="o">&gt;</span> <span class="n">vd</span><span class="o">-&gt;</span><span class="n">vdev_top</span><span class="o">-&gt;</span><span class="n">vdev_ashift</span> <span class="o">&amp;&amp;</span>
            <span class="n">vd</span><span class="o">-&gt;</span><span class="n">vdev_ops</span><span class="o">-&gt;</span><span class="n">vdev_op_leaf</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">zfs_ereport_post</span><span class="p">(</span><span class="n">FM_EREPORT_ZFS_DEVICE_BAD_ASHIFT</span><span class="p">,</span>
                <span class="n">spa</span><span class="p">,</span> <span class="n">vd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>

  <span class="cm">/* ... skipped ... */</span>

<span class="p">}</span>
</pre></div>


<p>我们可以直接把zfs-zed服务关掉，这样再也不用收到<code>vdev.bad_ashift</code>错误了。但zed有错吗？为什么要zed躺枪？而且就算没有<code>vdev.bad_ashift</code>日志，仍然会有大量的磁盘分区日志。</p>
<p>以其关掉zfs-zed服务，还不如把Marvell raid状态检测的时间间隔拉长一些，5分钟一次os盘的检测有点太频繁了。</p>
<p>跟怎么减少日志相比，我更感兴趣的是，这些日志是怎么来的。接下来继续分析。</p>
<h3>不正常的uevent</h3>
<p>刚才说过，<code>vdev.bad_ashift</code>错误是在<code>vdev_open()</code>的时候产生的，但<code>vdev_open()</code>不应该经常调用的。通过观察，偶然发现磁盘链接消失。zpool使用的是scsi-xxxxxx这样的设备路径，当设备有变化的时候，<code>vdev_open()</code>被调用也就不奇怪了。</p>
<p><img alt="dev_link_removed1" src="/images/dev_link_removed2.png"></p>
<p>为了证实系统确实有进行设备路径link的删除操作，用<code>udevadm monitor</code>去观察，很快就实锤。</p>
<div class="highlight"><pre><span class="n">monitor</span> <span class="n">will</span> <span class="n">print</span> <span class="n">the</span> <span class="n">received</span> <span class="n">events</span> <span class="k">for</span><span class="o">:</span>
<span class="n">UDEV</span> <span class="o">-</span> <span class="n">the</span> <span class="n">event</span> <span class="n">which</span> <span class="n">udev</span> <span class="n">sends</span> <span class="n">out</span> <span class="n">after</span> <span class="n">rule</span> <span class="n">processing</span>
<span class="n">KERNEL</span> <span class="o">-</span> <span class="n">the</span> <span class="n">kernel</span> <span class="n">uevent</span>

<span class="n">KERNEL</span><span class="p">[</span><span class="mf">1719771.836799</span><span class="p">]</span> <span class="n">remove</span>   <span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">pci0000</span><span class="o">:</span><span class="n">b2</span><span class="o">/</span><span class="mo">0000</span><span class="o">:</span><span class="n">b2</span><span class="o">:</span><span class="mf">00.0</span><span class="o">/</span><span class="mo">0000</span><span class="o">:</span><span class="n">b3</span><span class="o">:</span><span class="mf">00.0</span><span class="o">/</span><span class="n">host0</span><span class="o">/</span><span class="n">port</span><span class="o">-</span><span class="mi">0</span><span class="o">:</span><span class="mi">0</span><span class="o">/</span><span class="n">expander</span><span class="o">-</span><span class="mi">0</span><span class="o">:</span><span class="mi">0</span><span class="o">/</span><span class="n">port</span><span class="o">-</span><span class="mi">0</span><span class="o">:</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="o">/</span><span class="n">expander</span><span class="o">-</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="o">/</span><span class="n">port</span><span class="o">-</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="o">/</span><span class="n">end_device</span><span class="o">-</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="o">/</span><span class="n">target0</span><span class="o">:</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="o">/</span><span class="mi">0</span><span class="o">:</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="o">/</span><span class="n">block</span><span class="o">/</span><span class="n">sda</span><span class="o">/</span><span class="n">sda1</span> <span class="p">(</span><span class="n">block</span><span class="p">)</span>
<span class="n">KERNEL</span><span class="p">[</span><span class="mf">1719771.836814</span><span class="p">]</span> <span class="n">remove</span>   <span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">pci0000</span><span class="o">:</span><span class="n">b2</span><span class="o">/</span><span class="mo">0000</span><span class="o">:</span><span class="n">b2</span><span class="o">:</span><span class="mf">00.0</span><span class="o">/</span><span class="mo">0000</span><span class="o">:</span><span class="n">b3</span><span class="o">:</span><span class="mf">00.0</span><span class="o">/</span><span class="n">host0</span><span class="o">/</span><span class="n">port</span><span class="o">-</span><span class="mi">0</span><span class="o">:</span><span class="mi">0</span><span class="o">/</span><span class="n">expander</span><span class="o">-</span><span class="mi">0</span><span class="o">:</span><span class="mi">0</span><span class="o">/</span><span class="n">port</span><span class="o">-</span><span class="mi">0</span><span class="o">:</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="o">/</span><span class="n">expander</span><span class="o">-</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="o">/</span><span class="n">port</span><span class="o">-</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="o">/</span><span class="n">end_device</span><span class="o">-</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="o">/</span><span class="n">target0</span><span class="o">:</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="o">/</span><span class="mi">0</span><span class="o">:</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="o">/</span><span class="n">block</span><span class="o">/</span><span class="n">sda</span><span class="o">/</span><span class="n">sda9</span> <span class="p">(</span><span class="n">block</span><span class="p">)</span>
<span class="n">KERNEL</span><span class="p">[</span><span class="mf">1719771.878747</span><span class="p">]</span> <span class="n">change</span>   <span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">pci0000</span><span class="o">:</span><span class="n">b2</span><span class="o">/</span><span class="mo">0000</span><span class="o">:</span><span class="n">b2</span><span class="o">:</span><span class="mf">00.0</span><span class="o">/</span><span class="mo">0000</span><span class="o">:</span><span class="n">b3</span><span class="o">:</span><span class="mf">00.0</span><span class="o">/</span><span class="n">host0</span><span class="o">/</span><span class="n">port</span><span class="o">-</span><span class="mi">0</span><span class="o">:</span><span class="mi">0</span><span class="o">/</span><span class="n">expander</span><span class="o">-</span><span class="mi">0</span><span class="o">:</span><span class="mi">0</span><span class="o">/</span><span class="n">port</span><span class="o">-</span><span class="mi">0</span><span class="o">:</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="o">/</span><span class="n">expander</span><span class="o">-</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="o">/</span><span class="n">port</span><span class="o">-</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="o">/</span><span class="n">end_device</span><span class="o">-</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="o">/</span><span class="n">target0</span><span class="o">:</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="o">/</span><span class="mi">0</span><span class="o">:</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="o">/</span><span class="n">block</span><span class="o">/</span><span class="n">sda</span> <span class="p">(</span><span class="n">block</span><span class="p">)</span>
<span class="n">KERNEL</span><span class="p">[</span><span class="mf">1719771.878826</span><span class="p">]</span> <span class="n">add</span>      <span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">pci0000</span><span class="o">:</span><span class="n">b2</span><span class="o">/</span><span class="mo">0000</span><span class="o">:</span><span class="n">b2</span><span class="o">:</span><span class="mf">00.0</span><span class="o">/</span><span class="mo">0000</span><span class="o">:</span><span class="n">b3</span><span class="o">:</span><span class="mf">00.0</span><span class="o">/</span><span class="n">host0</span><span class="o">/</span><span class="n">port</span><span class="o">-</span><span class="mi">0</span><span class="o">:</span><span class="mi">0</span><span class="o">/</span><span class="n">expander</span><span class="o">-</span><span class="mi">0</span><span class="o">:</span><span class="mi">0</span><span class="o">/</span><span class="n">port</span><span class="o">-</span><span class="mi">0</span><span class="o">:</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="o">/</span><span class="n">expander</span><span class="o">-</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="o">/</span><span class="n">port</span><span class="o">-</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="o">/</span><span class="n">end_device</span><span class="o">-</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="o">/</span><span class="n">target0</span><span class="o">:</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="o">/</span><span class="mi">0</span><span class="o">:</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="o">/</span><span class="n">block</span><span class="o">/</span><span class="n">sda</span><span class="o">/</span><span class="n">sda1</span> <span class="p">(</span><span class="n">block</span><span class="p">)</span>
<span class="n">KERNEL</span><span class="p">[</span><span class="mf">1719771.878877</span><span class="p">]</span> <span class="n">add</span>      <span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">pci0000</span><span class="o">:</span><span class="n">b2</span><span class="o">/</span><span class="mo">0000</span><span class="o">:</span><span class="n">b2</span><span class="o">:</span><span class="mf">00.0</span><span class="o">/</span><span class="mo">0000</span><span class="o">:</span><span class="n">b3</span><span class="o">:</span><span class="mf">00.0</span><span class="o">/</span><span class="n">host0</span><span class="o">/</span><span class="n">port</span><span class="o">-</span><span class="mi">0</span><span class="o">:</span><span class="mi">0</span><span class="o">/</span><span class="n">expander</span><span class="o">-</span><span class="mi">0</span><span class="o">:</span><span class="mi">0</span><span class="o">/</span><span class="n">port</span><span class="o">-</span><span class="mi">0</span><span class="o">:</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="o">/</span><span class="n">expander</span><span class="o">-</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="o">/</span><span class="n">port</span><span class="o">-</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="o">/</span><span class="n">end_device</span><span class="o">-</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="o">/</span><span class="n">target0</span><span class="o">:</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="o">/</span><span class="mi">0</span><span class="o">:</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="o">/</span><span class="n">block</span><span class="o">/</span><span class="n">sda</span><span class="o">/</span><span class="n">sda9</span> <span class="p">(</span><span class="n">block</span><span class="p">)</span>
</pre></div>


<p>设备的分区信息被remove之后，又很快重新add回来，这是什么骚操作？</p>
<h3>uevent追踪</h3>
<p>我们知道，问题的源头是来自于<code>mvcli</code>，用<code>strace</code>命令去查看<code>mvcli</code>的操作过程，发现它除了做一些很无聊的事情外，并没有什么remove/add/change设备或类似的操作。</p>
<p>从<code>udevadm monitor</code>的信息可以看出，remove/add操作是来自于内核，所以可以看看内核是怎么调用uevent发送的。搜索一下kernel的uevent发送机制，发现是通过<code>kobject_uevent</code>来发uevent的，参考<a href="https://stackoverflow.com/questions/22803469/uevent-sent-from-kernel-to-user-space-udev">stackoverflow的回答</a>。用systemtap来尝试捕获信息，下面是systemtap脚本：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span class="err">#</span><span class="o">!</span><span class="err">/usr/bin/stap</span>


<span class="nx">global</span> <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span>


<span class="nx">probe</span> <span class="nx">kernel</span><span class="p">.</span><span class="kd">function</span><span class="p">(</span><span class="s2">&quot;kobject_uevent&quot;</span><span class="p">).</span><span class="nx">call</span> <span class="p">{</span>
    <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;---------------------\n&quot;</span><span class="p">);</span>
    <span class="nx">print_backtrace</span><span class="p">();</span>
    <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;---------------------\n&quot;</span><span class="p">);</span>
    <span class="nx">count</span> <span class="o">++</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">count</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">exit</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>得到下面的结果：</p>
<div class="highlight"><pre><span class="o">---------------------</span>
 <span class="mh">0xffffffff84979c10</span> <span class="o">:</span> <span class="n">kobject_uevent</span><span class="o">+</span><span class="mh">0x0</span><span class="o">/</span><span class="mh">0x10</span> <span class="p">[</span><span class="n">kernel</span><span class="p">]</span>
 <span class="mh">0xffffffff84aa3813</span> <span class="o">:</span> <span class="n">device_del</span><span class="o">+</span><span class="mh">0x193</span><span class="o">/</span><span class="mh">0x210</span> <span class="p">[</span><span class="n">kernel</span><span class="p">]</span>
 <span class="mh">0xffffffff8495bde8</span> <span class="o">:</span> <span class="n">delete_partition</span><span class="o">+</span><span class="mh">0x48</span><span class="o">/</span><span class="mh">0x80</span> <span class="p">[</span><span class="n">kernel</span><span class="p">]</span>
 <span class="mh">0xffffffff8495be66</span> <span class="o">:</span> <span class="n">drop_partitions</span><span class="p">.</span><span class="n">isra</span><span class="mf">.10</span><span class="p">.</span><span class="n">part</span><span class="mf">.11</span><span class="o">+</span><span class="mh">0x46</span><span class="o">/</span><span class="mh">0x80</span> <span class="p">[</span><span class="n">kernel</span><span class="p">]</span>
 <span class="mh">0xffffffff8495c3a6</span> <span class="o">:</span> <span class="n">rescan_partitions</span><span class="o">+</span><span class="mh">0x76</span><span class="o">/</span><span class="mh">0x2c0</span> <span class="p">[</span><span class="n">kernel</span><span class="p">]</span>
 <span class="mh">0xffffffff84956bc9</span> <span class="o">:</span> <span class="n">__blkdev_reread_part</span><span class="o">+</span><span class="mh">0x69</span><span class="o">/</span><span class="mh">0x70</span> <span class="p">[</span><span class="n">kernel</span><span class="p">]</span>
 <span class="mh">0xffffffff84956bf3</span> <span class="o">:</span> <span class="n">blkdev_reread_part</span><span class="o">+</span><span class="mh">0x23</span><span class="o">/</span><span class="mh">0x40</span> <span class="p">[</span><span class="n">kernel</span><span class="p">]</span>
 <span class="mh">0xffffffff849577ed</span> <span class="o">:</span> <span class="n">blkdev_ioctl</span><span class="o">+</span><span class="mh">0x4ed</span><span class="o">/</span><span class="mh">0xa20</span> <span class="p">[</span><span class="n">kernel</span><span class="p">]</span>
 <span class="mh">0xffffffff84880771</span> <span class="o">:</span> <span class="n">block_ioctl</span><span class="o">+</span><span class="mh">0x41</span><span class="o">/</span><span class="mh">0x50</span> <span class="p">[</span><span class="n">kernel</span><span class="p">]</span>
 <span class="mh">0xffffffff84856210</span> <span class="o">:</span> <span class="n">do_vfs_ioctl</span><span class="o">+</span><span class="mh">0x3a0</span><span class="o">/</span><span class="mh">0x5a0</span> <span class="p">[</span><span class="n">kernel</span><span class="p">]</span>
 <span class="mh">0xffffffff848564b1</span> <span class="o">:</span> <span class="n">sys_ioctl</span><span class="o">+</span><span class="mh">0xa1</span><span class="o">/</span><span class="mh">0xc0</span> <span class="p">[</span><span class="n">kernel</span><span class="p">]</span>
 <span class="mh">0xffffffff84d74ddb</span> <span class="o">:</span> <span class="n">system_call_fastpath</span><span class="o">+</span><span class="mh">0x22</span><span class="o">/</span><span class="mh">0x27</span> <span class="p">[</span><span class="n">kernel</span><span class="p">]</span>
 <span class="mh">0x7f1c051fb8d7</span>
<span class="o">---------------------</span>
</pre></div>


<p>可以看到<code>kobject_uevent</code>是在<code>ioctl</code>这个系统调用之后产生的。回过头来再看<code>mvcli</code>的strace日志，没有什么特别的<code>ioctl</code>调用。调查一度陷入困境。</p>
<p>uevent在用户态一般是由udevd来监听处理的，在RHEL7，这个服务是systemd-udevd，属于systemd的一部分。尝试去strace systemd-udevd进程，果然发现有趣的调用。</p>
<div class="highlight"><pre><span class="mi">1220</span>  <span class="mi">16</span><span class="o">:</span><span class="mi">57</span><span class="o">:</span><span class="mf">33.236947</span> <span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/sda&quot;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="o">|</span><span class="n">O_NONBLOCK</span><span class="o">|</span><span class="n">O_NOFOLLOW</span><span class="o">|</span><span class="n">O_CLOEXEC</span><span class="p">)</span> <span class="o">=</span> <span class="mi">12</span> <span class="o">&lt;</span><span class="mf">0.000021</span><span class="o">&gt;</span>
<span class="mi">1220</span>  <span class="mi">16</span><span class="o">:</span><span class="mi">57</span><span class="o">:</span><span class="mf">33.236994</span> <span class="n">flock</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="n">LOCK_EX</span><span class="o">|</span><span class="n">LOCK_NB</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;</span><span class="mf">0.000012</span><span class="o">&gt;</span>
<span class="mi">1220</span>  <span class="mi">16</span><span class="o">:</span><span class="mi">57</span><span class="o">:</span><span class="mf">33.237026</span> <span class="n">ioctl</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="n">BLKRRPART</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;</span><span class="mf">0.032882</span><span class="o">&gt;</span>
<span class="mi">1220</span>  <span class="mi">16</span><span class="o">:</span><span class="mi">57</span><span class="o">:</span><span class="mf">33.269962</span> <span class="n">close</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>         <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;</span><span class="mf">0.000038</span><span class="o">&gt;</span>
</pre></div>


<p>参考<a href="http://man7.org/linux/man-pages/man4/sd.4.html">man sd(4)</a>，BLKRRPART是强制重读scsi硬盘的硬盘分区操作。</p>
<div class="highlight"><pre>       <span class="n">BLKRRPART</span>
              <span class="n">Forces</span> <span class="n">a</span> <span class="n">reread</span> <span class="n">of</span> <span class="n">the</span> <span class="n">SCSI</span> <span class="n">disk</span> <span class="n">partition</span> <span class="n">tables</span><span class="p">.</span>  <span class="n">No</span> <span class="n">parame</span><span class="err">‐</span>
              <span class="n">ter</span> <span class="n">is</span> <span class="n">needed</span><span class="p">.</span>
</pre></div>


<p>那么，为什么systemd-udevd要做这个操作呢？下载systemd的代码进行分析。还好一搜BLKRRPART就出来了，是在<code>synthesize_change</code>这个函数里执行的：</p>
<div class="highlight"><pre><span class="cm">/* systemd-219 - src/udev/udevd.c */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">synthesize_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">udev_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
  <span class="cm">/* ... skipped ... */</span>

                <span class="cm">/*</span>
<span class="cm">                 * Try to re-read the partition table. This only succeeds if</span>
<span class="cm">                 * none of the devices is busy. The kernel returns 0 if no</span>
<span class="cm">                 * partition table is found, and we will not get an event for</span>
<span class="cm">                 * the disk.</span>
<span class="cm">                 */</span>
                <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">udev_device_get_devnode</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">O_RDONLY</span><span class="o">|</span><span class="n">O_CLOEXEC</span><span class="o">|</span><span class="n">O_NOFOLLOW</span><span class="o">|</span><span class="n">O_NONBLOCK</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="n">flock</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">LOCK_EX</span><span class="o">|</span><span class="n">LOCK_NB</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
                                <span class="n">r</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">BLKRRPART</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

                        <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
                                <span class="n">part_table_read</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="p">}</span>

  <span class="cm">/* ... skipped ... */</span>

<span class="p">}</span>
</pre></div>


<p>而<code>synthesize_change</code>是在什么情况下被调用的？可以看下面的代码，当event的watch mask是IN_CLOSE_WRITE的时候，就会执行。</p>
<div class="highlight"><pre><span class="cm">/* systemd-219 - src/udev/udevd.c */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">handle_inotify</span><span class="p">(</span><span class="k">struct</span> <span class="n">udev</span> <span class="o">*</span><span class="n">udev</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">union</span> <span class="n">inotify_event_buffer</span> <span class="n">buffer</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">inotify_event</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
        <span class="kt">ssize_t</span> <span class="n">l</span><span class="p">;</span>

        <span class="n">l</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd_inotify</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">EAGAIN</span> <span class="o">||</span> <span class="n">errno</span> <span class="o">==</span> <span class="n">EINTR</span><span class="p">)</span>
                        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

                <span class="k">return</span> <span class="n">log_error_errno</span><span class="p">(</span><span class="n">errno</span><span class="p">,</span> <span class="s">&quot;Failed to read inotify fd: %m&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">FOREACH_INOTIFY_EVENT</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">struct</span> <span class="n">udev_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

                <span class="n">dev</span> <span class="o">=</span> <span class="n">udev_watch_lookup</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">wd</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
                        <span class="k">continue</span><span class="p">;</span>

                <span class="n">log_debug</span><span class="p">(</span><span class="s">&quot;inotify event: %x for %s&quot;</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">,</span> <span class="n">udev_device_get_devnode</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">IN_CLOSE_WRITE</span><span class="p">)</span>
                        <span class="n">synthesize_change</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">IN_IGNORED</span><span class="p">)</span>
                        <span class="n">udev_watch_end</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

                <span class="n">udev_device_unref</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
        <span class="p">}</span>
</pre></div>


<p>参考<a href="http://man7.org/linux/man-pages/man7/inotify.7.html">man inotify(7)</a>，当文件被可写的方式打开，文件关闭的时候会产生IN_CLOSE_WRITE。</p>
<div class="highlight"><pre>           <span class="n">IN_CLOSE_WRITE</span> <span class="p">(</span><span class="o">+</span><span class="p">)</span>
                  <span class="n">File</span> <span class="n">opened</span> <span class="k">for</span> <span class="n">writing</span> <span class="n">was</span> <span class="n">closed</span><span class="p">.</span>
</pre></div>


<p>结合man中的例子学习一下：</p>
<div class="highlight"><pre>   <span class="n">Examples</span>
       <span class="n">Suppose</span> <span class="n">an</span> <span class="n">application</span> <span class="n">is</span> <span class="n">watching</span> <span class="n">the</span> <span class="n">directory</span> <span class="n">dir</span> <span class="n">and</span> <span class="n">the</span> <span class="n">file</span>
       <span class="n">dir</span><span class="o">/</span><span class="n">myfile</span> <span class="k">for</span> <span class="n">all</span> <span class="n">events</span><span class="p">.</span>  <span class="n">The</span> <span class="n">examples</span> <span class="n">below</span> <span class="n">show</span> <span class="n">some</span> <span class="n">events</span> <span class="n">that</span>
       <span class="n">will</span> <span class="n">be</span> <span class="n">generated</span> <span class="k">for</span> <span class="n">these</span> <span class="n">two</span> <span class="n">objects</span><span class="p">.</span>

           <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">&quot;dir/myfile&quot;</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
                  <span class="n">Generates</span> <span class="n">IN_OPEN</span> <span class="n">events</span> <span class="k">for</span> <span class="n">both</span> <span class="n">dir</span> <span class="n">and</span> <span class="n">dir</span><span class="o">/</span><span class="n">myfile</span><span class="p">.</span>

           <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
                  <span class="n">Generates</span> <span class="n">IN_ACCESS</span> <span class="n">events</span> <span class="k">for</span> <span class="n">both</span> <span class="n">dir</span> <span class="n">and</span> <span class="n">dir</span><span class="o">/</span><span class="n">myfile</span><span class="p">.</span>

           <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
                  <span class="n">Generates</span> <span class="n">IN_MODIFY</span> <span class="n">events</span> <span class="k">for</span> <span class="n">both</span> <span class="n">dir</span> <span class="n">and</span> <span class="n">dir</span><span class="o">/</span><span class="n">myfile</span><span class="p">.</span>

           <span class="n">fchmod</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
                  <span class="n">Generates</span> <span class="n">IN_ATTRIB</span> <span class="n">events</span> <span class="k">for</span> <span class="n">both</span> <span class="n">dir</span> <span class="n">and</span> <span class="n">dir</span><span class="o">/</span><span class="n">myfile</span><span class="p">.</span>

           <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
                  <span class="n">Generates</span> <span class="n">IN_CLOSE_WRITE</span> <span class="n">events</span> <span class="k">for</span> <span class="n">both</span> <span class="n">dir</span> <span class="n">and</span>
                  <span class="n">dir</span><span class="o">/</span><span class="n">myfile</span><span class="p">.</span>
</pre></div>


<p>从以上信息，可以知道/dev/sda产生了IN_CLOSE_WRITE事件，导致systemd-udevd执行重读分区表，触发remove/add之类的操作。那到底是什么进程以可写的方式打开并关闭了设备？从<code>mvcli</code>命令的strace结果，可以找到下面的信息</p>
<div class="highlight"><pre><span class="mi">110725</span> <span class="mi">14</span><span class="o">:</span><span class="mi">58</span><span class="o">:</span><span class="mf">49.280185</span> <span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/sda&quot;</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="o">|</span><span class="n">O_NONBLOCK</span><span class="p">)</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">&lt;</span><span class="mf">0.000015</span><span class="o">&gt;</span>
<span class="mi">110725</span> <span class="mi">14</span><span class="o">:</span><span class="mi">58</span><span class="o">:</span><span class="mf">49.280222</span> <span class="n">ioctl</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">SG_IO</span><span class="p">,</span> <span class="p">{</span><span class="sc">&#39;S&#39;</span><span class="p">,</span> <span class="n">SG_DXFER_FROM_DEV</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mo">01</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="mo">00</span><span class="p">],</span> <span class="n">mx_sb_len</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">iovec_count</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dxfer_len</span><span class="o">=</span><span class="mi">252</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60000</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mo">00</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mi">08</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">4</span><span class="n">d</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">44</span><span class="p">],</span> <span class="n">status</span><span class="o">=</span><span class="mo">00</span><span class="p">,</span> <span class="n">masked_status</span><span class="o">=</span><span class="mo">00</span><span class="p">,</span> <span class="n">sb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="p">[],</span> <span class="n">host_status</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">driver_status</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">resid</span><span class="o">=</span><span class="mi">240</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="mi">0</span><span class="p">})</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;</span><span class="mf">0.000149</span><span class="o">&gt;</span>
<span class="mi">110725</span> <span class="mi">14</span><span class="o">:</span><span class="mi">58</span><span class="o">:</span><span class="mf">49.280425</span> <span class="n">close</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>         <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;</span><span class="mf">0.000021</span><span class="o">&gt;</span>
</pre></div>


<p>ioctl执行了scsi命令<code>cmd[6]=[12, 01, 80, 00, fc, 00]</code>，这是scsi INQUIRY命令，查询page code 80h（Unit Serial Number），详细可以参考seagate的<a href="https://www.seagate.com/files/staticfiles/support/docs/manual/Interface%20manuals/100293068k.pdf">Interface manuals</a>。命令只是取一下硬盘的信息，但以<code>O_RDWR</code>的方式打开设备，会触发systemd-udevd重读分区表操作，这是问题所在。</p>
<p>为了进一步确认确实是systemd-udevd执行了<code>synthesize_change</code>操作，可以打开systemd-udevd的debug日志。根据代码，会产生<code>synthesising partition</code>这样的日志：</p>
<div class="highlight"><pre><span class="cm">/* systemd-219 - src/udev/udevd.c */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">synthesize_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">udev_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>

  <span class="cm">/* ... skipped ... */</span>

                <span class="cm">/*</span>
<span class="cm">                 * We have partitions but re-reading the partition table did not</span>
<span class="cm">                 * work, synthesize &quot;change&quot; for the disk and all partitions.</span>
<span class="cm">                 */</span>
                <span class="n">log_debug</span><span class="p">(</span><span class="s">&quot;device %s closed, synthesising &#39;change&#39;&quot;</span><span class="p">,</span> <span class="n">udev_device_get_devnode</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
                <span class="n">strscpyl</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">udev_device_get_syspath</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="s">&quot;/uevent&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
                <span class="n">write_string_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;change&quot;</span><span class="p">);</span>

                <span class="n">udev_list_entry_foreach</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">udev_enumerate_get_list_entry</span><span class="p">(</span><span class="n">e</span><span class="p">))</span> <span class="p">{</span>
                        <span class="n">_cleanup_udev_device_unref_</span> <span class="k">struct</span> <span class="n">udev_device</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

                        <span class="n">d</span> <span class="o">=</span> <span class="n">udev_device_new_from_syspath</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">udev_list_entry_get_name</span><span class="p">(</span><span class="n">item</span><span class="p">));</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">d</span><span class="p">)</span>
                                <span class="k">continue</span><span class="p">;</span>

                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">streq_ptr</span><span class="p">(</span><span class="s">&quot;partition&quot;</span><span class="p">,</span> <span class="n">udev_device_get_devtype</span><span class="p">(</span><span class="n">d</span><span class="p">)))</span>
                                <span class="k">continue</span><span class="p">;</span>

                        <span class="n">log_debug</span><span class="p">(</span><span class="s">&quot;device %s closed, synthesising partition &#39;%s&#39; &#39;change&#39;&quot;</span><span class="p">,</span>
                                  <span class="n">udev_device_get_devnode</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">udev_device_get_devnode</span><span class="p">(</span><span class="n">d</span><span class="p">));</span>
                        <span class="n">strscpyl</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">udev_device_get_syspath</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="s">&quot;/uevent&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
                        <span class="n">write_string_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;change&quot;</span><span class="p">);</span>
                <span class="p">}</span>

  <span class="cm">/* ... skipped ... */</span>

<span class="p">}</span>
</pre></div>


<p>然后在日志中，确实能找到代码中的信息：</p>
<div class="highlight"><pre><span class="n">Dec</span> <span class="mi">16</span> <span class="mi">13</span><span class="o">:</span><span class="mi">32</span><span class="o">:</span><span class="mi">42</span> <span class="n">myserver</span> <span class="n">systemd</span><span class="o">-</span><span class="n">udevd</span><span class="p">[</span><span class="mi">291102</span><span class="p">]</span><span class="o">:</span> <span class="n">inotify</span> <span class="n">event</span><span class="o">:</span> <span class="mi">8</span> <span class="k">for</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sdac</span>
<span class="n">Dec</span> <span class="mi">16</span> <span class="mi">13</span><span class="o">:</span><span class="mi">32</span><span class="o">:</span><span class="mi">42</span> <span class="n">myserver</span> <span class="n">systemd</span><span class="o">-</span><span class="n">udevd</span><span class="p">[</span><span class="mi">291102</span><span class="p">]</span><span class="o">:</span> <span class="n">device</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sdac</span> <span class="n">closed</span><span class="p">,</span> <span class="n">synthesising</span> <span class="err">&#39;</span><span class="n">change</span><span class="err">&#39;</span>
<span class="n">Dec</span> <span class="mi">16</span> <span class="mi">13</span><span class="o">:</span><span class="mi">32</span><span class="o">:</span><span class="mi">42</span> <span class="n">myserver</span> <span class="n">systemd</span><span class="o">-</span><span class="n">udevd</span><span class="p">[</span><span class="mi">291102</span><span class="p">]</span><span class="o">:</span> <span class="n">device</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sdac</span> <span class="n">closed</span><span class="p">,</span> <span class="n">synthesising</span> <span class="n">partition</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sdac1</span><span class="sc">&#39; &#39;</span><span class="n">ch</span>
<span class="n">Dec</span> <span class="mi">16</span> <span class="mi">13</span><span class="o">:</span><span class="mi">32</span><span class="o">:</span><span class="mi">42</span> <span class="n">myserver</span> <span class="n">systemd</span><span class="o">-</span><span class="n">udevd</span><span class="p">[</span><span class="mi">291102</span><span class="p">]</span><span class="o">:</span> <span class="n">device</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sdac</span> <span class="n">closed</span><span class="p">,</span> <span class="n">synthesising</span> <span class="n">partition</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sdac9</span><span class="sc">&#39; &#39;</span><span class="n">ch</span>
</pre></div>


<h3>解决方案</h3>
<p>如何解决这个问题？由于<code>mvcli</code>没有开源，不太可能通过源码去修改。但通过strace分析，可以看到<code>mvcli</code>先创建 /tmp/diskList文件，然后读这个文件，再去做open和scsi INQUIRY。猜测程序是按/tmp/diskList文件中的设备，挨个去执行scsi INQUIRY。</p>
<div class="highlight"><pre><span class="mi">110746</span> <span class="mi">14</span><span class="o">:</span><span class="mi">58</span><span class="o">:</span><span class="mf">49.231097</span> <span class="n">execve</span><span class="p">(</span><span class="s">&quot;/bin/sh&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;sh&quot;</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;ls /dev/sd* 2&gt;/dev/null | grep &#39;[^0-9]$&#39; &gt; /tmp/diskList&quot;</span><span class="p">],</span> <span class="p">[</span><span class="cm">/* 29 vars */</span><span class="p">])</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;</span><span class="mf">0.000171</span><span class="o">&gt;</span>

<span class="mi">110725</span> <span class="mi">14</span><span class="o">:</span><span class="mi">58</span><span class="o">:</span><span class="mf">49.280045</span> <span class="n">open</span><span class="p">(</span><span class="s">&quot;/tmp/diskList&quot;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">)</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">&lt;</span><span class="mf">0.000012</span><span class="o">&gt;</span>
<span class="mi">110725</span> <span class="mi">14</span><span class="o">:</span><span class="mi">58</span><span class="o">:</span><span class="mf">49.280076</span> <span class="n">fstat</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="p">{</span><span class="n">st_mode</span><span class="o">=</span><span class="n">S_IFREG</span><span class="o">|</span><span class="mo">0644</span><span class="p">,</span> <span class="n">st_size</span><span class="o">=</span><span class="mi">1664</span><span class="p">,</span> <span class="p">...})</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;</span><span class="mf">0.000009</span><span class="o">&gt;</span>
<span class="mi">110725</span> <span class="mi">14</span><span class="o">:</span><span class="mi">58</span><span class="o">:</span><span class="mf">49.280103</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_PRIVATE</span><span class="o">|</span><span class="n">MAP_ANONYMOUS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x7fb84ebe0000</span> <span class="o">&lt;</span><span class="mf">0.000011</span><span class="o">&gt;</span>
<span class="mi">110725</span> <span class="mi">14</span><span class="o">:</span><span class="mi">58</span><span class="o">:</span><span class="mf">49.280132</span> <span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;/dev/sda</span><span class="se">\n</span><span class="s">/dev/sdaa</span><span class="se">\n</span><span class="s">/dev/sdab</span><span class="se">\n</span><span class="s">/dev/sdac</span><span class="se">\n</span><span class="s">/dev/sdad</span><span class="se">\n</span><span class="s">/dev/sdae</span><span class="se">\n</span><span class="s">/dev/sdaf</span><span class="se">\n</span><span class="s">/dev/sdag</span><span class="se">\n</span><span class="s">/dev/sdah</span><span class="se">\n</span><span class="s">/dev/sdai</span><span class="se">\n</span><span class="s">/dev/sdaj</span><span class="se">\n</span><span class="s">/dev/sdak</span><span class="se">\n</span><span class="s">/dev/sdal</span><span class="se">\n</span><span class="s">/dev/sdam</span><span class="se">\n</span><span class="s">/dev/sdan</span><span class="se">\n</span><span class="s">/dev/sdao</span><span class="se">\n</span><span class="s">/dev/sdap</span><span class="se">\n</span><span class="s">/dev/sdaq</span><span class="se">\n</span><span class="s">/dev/sdar</span><span class="se">\n</span><span class="s">/dev/sdas</span><span class="se">\n</span><span class="s">/dev/sdat</span><span class="se">\n</span><span class="s">/dev/sdau</span><span class="se">\n</span><span class="s">/dev/sdav</span><span class="se">\n</span><span class="s">/dev/sdaw</span><span class="se">\n</span><span class="s">/dev/sdax</span><span class="se">\n</span><span class="s">/dev/sday</span><span class="se">\n</span><span class="s">/dev/sdaz</span><span class="se">\n</span><span class="s">/dev/sdb</span><span class="se">\n</span><span class="s">/dev/sdba</span><span class="se">\n</span><span class="s">/dev/sdbb</span><span class="se">\n</span><span class="s">/dev/sdbc</span><span class="se">\n</span><span class="s">/dev/sdbd</span><span class="se">\n</span><span class="s">/dev/sdbe</span><span class="se">\n</span><span class="s">/dev/sdbf</span><span class="se">\n</span><span class="s">/dev/sdbg</span><span class="se">\n</span><span class="s">/dev/sdbh</span><span class="se">\n</span><span class="s">/dev/sdbi</span><span class="se">\n</span><span class="s">/dev/sdbj</span><span class="se">\n</span><span class="s">/dev/sdbk</span><span class="se">\n</span><span class="s">/dev/sdbl</span><span class="se">\n</span><span class="s">/dev/sdbm</span><span class="se">\n</span><span class="s">/dev/sdbn</span><span class="se">\n</span><span class="s">/dev/sdbo</span><span class="se">\n</span><span class="s">/dev/sdbp</span><span class="se">\n</span><span class="s">/dev/sdbq</span><span class="se">\n</span><span class="s">/dev/sdbr</span><span class="se">\n</span><span class="s">/dev/sdbs</span><span class="se">\n</span><span class="s">/dev/sdbt</span><span class="se">\n</span><span class="s">/dev/sdbu</span><span class="se">\n</span><span class="s">/dev/sdbv</span><span class="se">\n</span><span class="s">/dev/sdbw</span><span class="se">\n</span><span class="s">/dev/sdbx</span><span class="se">\n</span><span class="s">/dev/sdby</span><span class="se">\n</span><span class="s">/dev/sdbz</span><span class="se">\n</span><span class="s">/dev/sdc</span><span class="se">\n</span><span class="s">/dev/sdca</span><span class="se">\n</span><span class="s">/dev/sdcb</span><span class="se">\n</span><span class="s">/dev/sdcc</span><span class="se">\n</span><span class="s">/dev/sdcd</span><span class="se">\n</span><span class="s">/dev/sdce</span><span class="se">\n</span><span class="s">/dev/sdcf</span><span class="se">\n</span><span class="s">/dev/sdcg</span><span class="se">\n</span><span class="s">/dev/sdch</span><span class="se">\n</span><span class="s">/dev/sdci</span><span class="se">\n</span><span class="s">/dev/sdcj</span><span class="se">\n</span><span class="s">/dev/sdck</span><span class="se">\n</span><span class="s">/dev/sdcl</span><span class="se">\n</span><span class="s">/dev/sdcm</span><span class="se">\n</span><span class="s">/dev/sdcn</span><span class="se">\n</span><span class="s">/dev/sdco</span><span class="se">\n</span><span class="s">/dev/sdcp</span><span class="se">\n</span><span class="s">/dev/sdcq</span><span class="se">\n</span><span class="s">/dev/sdcr</span><span class="se">\n</span><span class="s">/dev/sdcs</span><span class="se">\n</span><span class="s">/dev/sdct</span><span class="se">\n</span><span class="s">/dev/sdcu</span><span class="se">\n</span><span class="s">/dev/sdcv</span><span class="se">\n</span><span class="s">/dev/sdcw</span><span class="se">\n</span><span class="s">/dev/sdcx</span><span class="se">\n</span><span class="s">/dev/sdcy</span><span class="se">\n</span><span class="s">/dev/sdcz</span><span class="se">\n</span><span class="s">/dev/sdd</span><span class="se">\n</span><span class="s">/dev/sdda</span><span class="se">\n</span><span class="s">/dev/sddb</span><span class="se">\n</span><span class="s">/dev/sddc</span><span class="se">\n</span><span class="s">/dev/sddd</span><span class="se">\n</span><span class="s">/dev/sdde</span><span class="se">\n</span><span class="s">/dev/sddf</span><span class="se">\n</span><span class="s">/dev/sddg</span><span class="se">\n</span><span class="s">/dev/sddh</span><span class="se">\n</span><span class="s">/dev/sddi</span><span class="se">\n</span><span class="s">/dev/sddj</span><span class="se">\n</span><span class="s">/dev/sddk</span><span class="se">\n</span><span class="s">/dev/sddl</span><span class="se">\n</span><span class="s">/dev/sddm</span><span class="se">\n</span><span class="s">/dev/sddn</span><span class="se">\n</span><span class="s">/dev/sddo</span><span class="se">\n</span><span class="s">/dev/sddp</span><span class="se">\n</span><span class="s">/dev/sddq</span><span class="se">\n</span><span class="s">/dev/sddr</span><span class="se">\n</span><span class="s">/dev/sdds</span><span class="se">\n</span><span class="s">/dev/sddt</span><span class="se">\n</span><span class="s">/dev/sddu</span><span class="se">\n</span><span class="s">/dev/sddv</span><span class="se">\n</span><span class="s">/dev/sddw</span><span class="se">\n</span><span class="s">/dev/sddx</span><span class="se">\n</span><span class="s">/dev/sddy</span><span class="se">\n</span><span class="s">/dev/sddz</span><span class="se">\n</span><span class="s">/dev/sde</span><span class="se">\n</span><span class="s">/dev/sdea</span><span class="se">\n</span><span class="s">/dev/sdeb</span><span class="se">\n</span><span class="s">/dev/sdec</span><span class="se">\n</span><span class="s">/dev/sded</span><span class="se">\n</span><span class="s">/dev/sdee</span><span class="se">\n</span><span class="s">/dev/sdef</span><span class="se">\n</span><span class="s">/dev/sdeg</span><span class="se">\n</span><span class="s">/dev/sdeh</span><span class="se">\n</span><span class="s">/dev/sdei</span><span class="se">\n</span><span class="s">/dev/sdej</span><span class="se">\n</span><span class="s">/dev/sdek</span><span class="se">\n</span><span class="s">/dev/sdel</span><span class="se">\n</span><span class="s">/dev/sdem</span><span class="se">\n</span><span class="s">/dev/sden</span><span class="se">\n</span><span class="s">/dev/sdeo</span><span class="se">\n</span><span class="s">/dev/sdep</span><span class="se">\n</span><span class="s">/dev/sdeq</span><span class="se">\n</span><span class="s">/dev/sder</span><span class="se">\n</span><span class="s">/dev/sdes</span><span class="se">\n</span><span class="s">/dev/sdet</span><span class="se">\n</span><span class="s">/dev/sdeu</span><span class="se">\n</span><span class="s">/dev/sdev</span><span class="se">\n</span><span class="s">/dev/sdew</span><span class="se">\n</span><span class="s">/dev/sdex</span><span class="se">\n</span><span class="s">/dev/sdey</span><span class="se">\n</span><span class="s">/dev/sdez</span><span class="se">\n</span><span class="s">/dev/sdf</span><span class="se">\n</span><span class="s">/dev/sdfa</span><span class="se">\n</span><span class="s">/dev/sdfb</span><span class="se">\n</span><span class="s">/dev/sdfc</span><span class="se">\n</span><span class="s">/dev/sdfd</span><span class="se">\n</span><span class="s">/dev/sdfe</span><span class="se">\n</span><span class="s">/dev/sdff</span><span class="se">\n</span><span class="s">/dev/sdfg</span><span class="se">\n</span><span class="s">/dev/sdfh</span><span class="se">\n</span><span class="s">/dev/sdfi</span><span class="se">\n</span><span class="s">/dev/sdfj</span><span class="se">\n</span><span class="s">/dev/sdfk</span><span class="se">\n</span><span class="s">/dev/sdfl</span><span class="se">\n</span><span class="s">/dev/sdfm</span><span class="se">\n</span><span class="s">/dev/sdg</span><span class="se">\n</span><span class="s">/dev/sdh</span><span class="se">\n</span><span class="s">/dev/sdi</span><span class="se">\n</span><span class="s">/dev/sdj</span><span class="se">\n</span><span class="s">/dev/sdk</span><span class="se">\n</span><span class="s">/dev/sdl</span><span class="se">\n</span><span class="s">/dev/sdm</span><span class="se">\n</span><span class="s">/dev/sdn</span><span class="se">\n</span><span class="s">/dev/sdo</span><span class="se">\n</span><span class="s">/dev/sdp</span><span class="se">\n</span><span class="s">/dev/sdq</span><span class="se">\n</span><span class="s">/dev/sdr</span><span class="se">\n</span><span class="s">/dev/sds</span><span class="se">\n</span><span class="s">/dev/sdt</span><span class="se">\n</span><span class="s">/dev/sdu</span><span class="se">\n</span><span class="s">/dev/sdv</span><span class="se">\n</span><span class="s">/dev/sdw</span><span class="se">\n</span><span class="s">/dev/sdx</span><span class="se">\n</span><span class="s">/dev/sdy</span><span class="se">\n</span><span class="s">/dev/sdz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1664</span> <span class="o">&lt;</span><span class="mf">0.000015</span><span class="o">&gt;</span>
</pre></div>


<p>由于Marvell raid只管理系统盘，在我们的系统中是/dev/sdfm，删除其他设备后，把/tmp/diskList文件用<code>chattr</code>命令加上不可更改属性，再去测试<code>mvcli</code>可以正常返回结果，无重读分区表的日志。打开zfs-zed服务，也没有再报<code>vdev.bad_ashift</code>错误。</p>
<p>没有源代码的情况下，禁止/tmp/diskList文件的修改是否会影响其他命令选项的使用是不确定的，所以为了减少影响，可以在监控脚本对<code>mvcli</code>进行封装，在执行前修改/tmp/diskList文件内容并加不可更改属性，执行后再改回来即可。</p>
<h3>其他信息</h3>
<ol>
<li><code>mvcli</code>会去扫描/sys/class/scsi_generic下面的sg设备，找到Marvell设备后，通过ioctl去收发scsi命令。</li>
</ol>
<div class="highlight"><pre><span class="mi">384462</span> <span class="mi">23</span><span class="o">:</span><span class="mi">57</span><span class="o">:</span><span class="mf">03.837807</span> <span class="n">open</span><span class="p">(</span><span class="s">&quot;/sys/class/scsi_generic/sg179/device/vendor&quot;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">)</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">&lt;</span><span class="mf">0.000021</span><span class="o">&gt;</span>
<span class="mi">384462</span> <span class="mi">23</span><span class="o">:</span><span class="mi">57</span><span class="o">:</span><span class="mf">03.837846</span> <span class="n">fstat</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="p">{</span><span class="n">st_mode</span><span class="o">=</span><span class="n">S_IFREG</span><span class="o">|</span><span class="mo">0444</span><span class="p">,</span> <span class="n">st_size</span><span class="o">=</span><span class="mi">4096</span><span class="p">,</span> <span class="p">...})</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;</span><span class="mf">0.000009</span><span class="o">&gt;</span>
<span class="mi">384462</span> <span class="mi">23</span><span class="o">:</span><span class="mi">57</span><span class="o">:</span><span class="mf">03.837878</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_PRIVATE</span><span class="o">|</span><span class="n">MAP_ANONYMOUS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x7f94a2903000</span> <span class="o">&lt;</span><span class="mf">0.000009</span><span class="o">&gt;</span>
<span class="mi">384462</span> <span class="mi">23</span><span class="o">:</span><span class="mi">57</span><span class="o">:</span><span class="mf">03.837904</span> <span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;Marvell </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span> <span class="o">=</span> <span class="mi">9</span> <span class="o">&lt;</span><span class="mf">0.000011</span><span class="o">&gt;</span>
<span class="mi">384462</span> <span class="mi">23</span><span class="o">:</span><span class="mi">57</span><span class="o">:</span><span class="mf">03.837933</span> <span class="n">close</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>         <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;</span><span class="mf">0.000009</span><span class="o">&gt;</span>
<span class="mi">384462</span> <span class="mi">23</span><span class="o">:</span><span class="mi">57</span><span class="o">:</span><span class="mf">03.837958</span> <span class="n">munmap</span><span class="p">(</span><span class="mh">0x7f94a2903000</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;</span><span class="mf">0.000010</span><span class="o">&gt;</span>
<span class="mi">384462</span> <span class="mi">23</span><span class="o">:</span><span class="mi">57</span><span class="o">:</span><span class="mf">03.837985</span> <span class="n">open</span><span class="p">(</span><span class="s">&quot;/sys/class/scsi_generic/sg179/device/model&quot;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">)</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">&lt;</span><span class="mf">0.000017</span><span class="o">&gt;</span>
<span class="mi">384462</span> <span class="mi">23</span><span class="o">:</span><span class="mi">57</span><span class="o">:</span><span class="mf">03.838022</span> <span class="n">fstat</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="p">{</span><span class="n">st_mode</span><span class="o">=</span><span class="n">S_IFREG</span><span class="o">|</span><span class="mo">0444</span><span class="p">,</span> <span class="n">st_size</span><span class="o">=</span><span class="mi">4096</span><span class="p">,</span> <span class="p">...})</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;</span><span class="mf">0.000009</span><span class="o">&gt;</span>
<span class="mi">384462</span> <span class="mi">23</span><span class="o">:</span><span class="mi">57</span><span class="o">:</span><span class="mf">03.838049</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_PRIVATE</span><span class="o">|</span><span class="n">MAP_ANONYMOUS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x7f94a2903000</span> <span class="o">&lt;</span><span class="mf">0.000009</span><span class="o">&gt;</span>
<span class="mi">384462</span> <span class="mi">23</span><span class="o">:</span><span class="mi">57</span><span class="o">:</span><span class="mf">03.838075</span> <span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;Console         </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span> <span class="o">=</span> <span class="mi">17</span> <span class="o">&lt;</span><span class="mf">0.000010</span><span class="o">&gt;</span>
<span class="mi">384462</span> <span class="mi">23</span><span class="o">:</span><span class="mi">57</span><span class="o">:</span><span class="mf">03.838104</span> <span class="n">close</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>         <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;</span><span class="mf">0.000009</span><span class="o">&gt;</span>
<span class="mi">384462</span> <span class="mi">23</span><span class="o">:</span><span class="mi">57</span><span class="o">:</span><span class="mf">03.838129</span> <span class="n">munmap</span><span class="p">(</span><span class="mh">0x7f94a2903000</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;</span><span class="mf">0.000010</span><span class="o">&gt;</span>
<span class="mi">384462</span> <span class="mi">23</span><span class="o">:</span><span class="mi">57</span><span class="o">:</span><span class="mf">03.838156</span> <span class="n">getdents</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="cm">/* 0 entries */</span><span class="p">,</span> <span class="mi">32768</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;</span><span class="mf">0.000010</span><span class="o">&gt;</span>
<span class="mi">384462</span> <span class="mi">23</span><span class="o">:</span><span class="mi">57</span><span class="o">:</span><span class="mf">03.838183</span> <span class="n">close</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>         <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;</span><span class="mf">0.000010</span><span class="o">&gt;</span>
<span class="mi">384462</span> <span class="mi">23</span><span class="o">:</span><span class="mi">57</span><span class="o">:</span><span class="mf">03.838209</span> <span class="n">stat</span><span class="p">(</span><span class="s">&quot;/dev/sg179&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">st_mode</span><span class="o">=</span><span class="n">S_IFCHR</span><span class="o">|</span><span class="mo">0600</span><span class="p">,</span> <span class="n">st_rdev</span><span class="o">=</span><span class="n">makedev</span><span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="mi">179</span><span class="p">),</span> <span class="p">...})</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;</span><span class="mf">0.000012</span><span class="o">&gt;</span>
<span class="mi">384462</span> <span class="mi">23</span><span class="o">:</span><span class="mi">57</span><span class="o">:</span><span class="mf">03.838242</span> <span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/sg179&quot;</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">)</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">&lt;</span><span class="mf">0.000017</span><span class="o">&gt;</span>
<span class="mi">384462</span> <span class="mi">23</span><span class="o">:</span><span class="mi">57</span><span class="o">:</span><span class="mf">03.838284</span> <span class="n">ioctl</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">SG_IO</span><span class="p">,</span> <span class="p">{</span><span class="sc">&#39;S&#39;</span><span class="p">,</span> <span class="n">SG_DXFER_FROM_DEV</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="mo">00</span><span class="p">],</span> <span class="n">mx_sb_len</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">iovec_count</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dxfer_len</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">20000</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">255</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mo">03</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mo">05</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mi">4</span><span class="n">d</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">6</span><span class="n">c</span><span class="p">,</span> <span class="mi">6</span><span class="n">c</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mf">6f</span><span class="p">,</span> <span class="mi">6</span><span class="n">e</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mf">6f</span><span class="p">,</span> <span class="mi">6</span><span class="n">c</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">2</span><span class="n">e</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mi">4</span><span class="n">d</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">4</span><span class="n">c</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">02</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">03</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">01</span><span class="p">,</span> <span class="mo">01</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="n">d3</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span> <span class="mi">8</span><span class="n">b</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mo">00</span><span class="p">],</span> <span class="n">status</span><span class="o">=</span><span class="mo">00</span><span class="p">,</span> <span class="n">masked_status</span><span class="o">=</span><span class="mo">00</span><span class="p">,</span> <span class="n">sb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="p">[],</span> <span class="n">host_status</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">driver_status</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">resid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="mi">0</span><span class="p">})</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;</span><span class="mf">0.000068</span><span class="o">&gt;</span>
</pre></div>


<ol>
<li><code>mvcli</code>命令主要的时间消耗在是pvdisplay，在strace记录中共花了18.8秒，搞不懂为什么会有这个需求。估计把lvm软件删除后命令就可以很快完成。</li>
</ol>
<div class="highlight"><pre><span class="mi">385141</span> <span class="mi">23</span><span class="o">:</span><span class="mi">57</span><span class="o">:</span><span class="mf">03.932932</span> <span class="n">execve</span><span class="p">(</span><span class="s">&quot;/usr/sbin/pvdisplay&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;pvdisplay&quot;</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">],</span> <span class="p">[</span><span class="cm">/* 27 vars */</span><span class="p">])</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;</span><span class="mf">0.000169</span><span class="o">&gt;</span>
<span class="mi">384999</span> <span class="mi">23</span><span class="o">:</span><span class="mi">57</span><span class="o">:</span><span class="mf">22.731182</span> <span class="o">&lt;</span><span class="p">...</span> <span class="n">wait4</span> <span class="n">resumed</span><span class="o">&gt;</span> <span class="p">[{</span><span class="n">WIFEXITED</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">WEXITSTATUS</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">}],</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">=</span> <span class="mi">385141</span> <span class="o">&lt;</span><span class="mf">18.798689</span><span class="o">&gt;</span>
</pre></div>


<ol>
<li>zfs on linux是通过ZED+FM(Fault Management)来实现disk-add、disk-change等事件的自动处理的，具体见<a href="https://github.com/zfsonlinux/zfs/blob/master/cmd/zed/agents/README.md">Fault Management Logic for ZED</a>。</li>
</ol></div>
    <footer>
<p class="meta">
  <span class="byline author vcard">
    Posted by <span class="fn">
        Yang Liping
    </span>
  </span>
<time datetime="2019-12-18T10:59:44.702032+08:00" pubdate>Wed 18 December 2019</time>  <span class="categories">
    <a class='category' href='http://www.yanglp.com/category/tech.html'>Tech</a>
  </span>
  <span class="categories">
    <a class="category" href="http://www.yanglp.com/tag/zfs.html">zfs</a>  </span>
</p><div class="sharing">
</div>    </footer>
  </article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
  </section>
</div>
<aside class="sidebar">
  <section>
    <h1>Recent Posts</h1>
    <ul id="recent_posts">
      <li class="post">
          <a href="http://www.yanglp.com/posts/2020/05/08/yong-gdb-deubg-bashshu-chu-bu-zheng-chang-wen-ti.html">用gdb deubg bash输出不正常问题</a>
      </li>
      <li class="post">
          <a href="http://www.yanglp.com/posts/2020/04/27/bashyin-yong-ming-ling-can-shu.html">bash引用命令参数</a>
      </li>
      <li class="post">
          <a href="http://www.yanglp.com/posts/2020/04/25/python-import-sgeku-wen-jian.html">python import sge库文件</a>
      </li>
      <li class="post">
          <a href="http://www.yanglp.com/posts/2019/12/18/mvclidao-zhi-da-liang-zfs-vdevbad_ashiftri-zhi.html">mvcli导致大量zfs vdev.bad_ashift日志</a>
      </li>
      <li class="post">
          <a href="http://www.yanglp.com/posts/2014/04/16/dnsde-aliashe-anameji-lu.html">DNS的ALIAS和ANAME记录</a>
      </li>
    </ul>
  </section>
  <section>
      
    <h1>Categories</h1>
    <ul id="recent_posts">
        <li><a href="http://www.yanglp.com/category/tech.html">Tech</a></li>
    </ul>
  </section>
 

  <section>
  <h1>Tags</h1>
    <a href="http://www.yanglp.com/tag/python.html">python</a>,    <a href="http://www.yanglp.com/tag/vim.html">vim</a>,    <a href="http://www.yanglp.com/tag/zfs.html">zfs</a>,    <a href="http://www.yanglp.com/tag/gdb.html">gdb</a>,    <a href="http://www.yanglp.com/tag/dns.html">DNS</a>,    <a href="http://www.yanglp.com/tag/linux.html">linux</a>,    <a href="http://www.yanglp.com/tag/sge.html">sge</a>,    <a href="http://www.yanglp.com/tag/bash.html">bash</a>  </section>


    <section>
        <h1>Blogroll</h1>
        <ul>
            <li><a href="http://getpelican.com/" target="_blank">Pelican</a></li>
            <li><a href="http://python.org/" target="_blank">Python.org</a></li>
            <li><a href="http://jinja.pocoo.org/" target="_blank">Jinja2</a></li>
        </ul>
    </section>

</aside>    </div>
  </div>
  <footer role="contentinfo"><p>
    Copyright &copy;  2014&ndash;2020  Yang Liping &mdash;
  <span class="credit">Powered by <a href="http://getpelican.com">Pelican</a></span>
</p></footer>
  <script src="http://www.yanglp.com/theme/js/modernizr-2.0.js"></script>
  <script src="http://www.yanglp.com/theme/js/ender.js"></script>
  <script src="http://www.yanglp.com/theme/js/octopress.js" type="text/javascript"></script>
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-50095101-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-50095101-1');
    ga('send', 'pageview');
</script>
  <script type="text/javascript">
    var disqus_shortname = 'yanglp';
    var disqus_identifier = '/posts/2019/12/18/mvclidao-zhi-da-liang-zfs-vdevbad_ashiftri-zhi.html';
    var disqus_url = 'http://www.yanglp.com/posts/2019/12/18/mvclidao-zhi-da-liang-zfs-vdevbad_ashiftri-zhi.html';
    var disqus_title = 'mvcli导致大量zfs vdev.bad_ashift日志';
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = "//" + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
  </script>
</body>
</html>